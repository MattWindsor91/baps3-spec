<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Message Protocol :: Bifrost Specification</title>
    <link rel="canonical" href="https://universityradioyork.github.io/baps3-spec/bifrost/message/spec.html">
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://universityradioyork.github.io/baps3-spec">Bifrost Specification</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://ury.org.uk">URY</a>
        <a class="navbar-item" href="https://universityradioyork.github.io">GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bifrost" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Bifrost Specification</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../conventions.html">Conventions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../compiling.html">Compiling</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">The Message Protocol</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="spec.html">Specification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tests.html">Compliance Tests</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../core/index.html">The Core Protocol</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../core/commands.html">Core Command Set</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../role/index.html">Roles</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../role/player.html"><code>player/file</code></a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../role/list.html"><code>list</code></a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../role/mux.html"><code>mux</code></a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../role/tracklister.html"><code>tracklister</code></a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../role/db.html"><code>db</code></a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Bifrost Specification</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Bifrost Specification</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Bifrost Specification</a></li>
    <li><a href="index.html">The Message Protocol</a></li>
    <li><a href="spec.html">Specification</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/mattbw/Documents/git/baps3-spec/bifrost/modules/message/pages/spec.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1 class="page">Message Protocol</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Bifrost <em>message protocol</em> is the base protocol Bifrost servers and
clients use to communicate.  It is designed to be:
criteria:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Composable</dt>
<dd>
<p>The API is intended to allow separate implementations of single
services to be composed into a single logical service, by connecting
servers together through the API.  Responses and requests not
intended for a server with upstream and downstream connections
respectively can be <em>forwarded</em> transparently along the API
connections;</p>
</dd>
<dt class="hdlist1">Transparent</dt>
<dd>
<p>The API is text-based, and can be inspected by humans using either
TCP/IP packet sniffing or connecting directly to services to be
inspected;</p>
</dd>
<dt class="hdlist1">Simple</dt>
<dd>
<p>The API uses a minimalistic line-orientated protocol, in which
each line is comprised of one or more words, and uses shell-style
word-escaping conventions (as well as C-style backslash escapes).
It is relatively simple to implement, requires little to no
external dependencies, and is modest in its usage of network
bandwidth.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design"><a class="anchor" href="#_design"></a>Design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message protocol is based upon <a href="http://pubs.opengroup.org/onlinepubs/009604599/utilities/xcu_chap02.html">POSIX shell</a> conventions. This is
because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is lightweight and relatively easy to parse;</p>
</li>
<li>
<p>It is a good match for the command-and-arguments style of the protocol layer
on top;
  API;</p>
</li>
<li>
<p>The shell style of escaping is convenient for escaping paths
(especially on Windows, where the single-quote syntax can avoid
needing to escape every backslash in a Windows path).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A disadvantage is that it is impossible to perform a context-free
splitting of input into lines; the line-feed character could be
escaped.  However, since the usual transport used by the message
protocol is TCP, and most TCP libraries provide unbuffered input in
chunks which may be smaller or larger than one line, this is not a
major issue.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_encoding"><a class="anchor" href="#_encoding"></a>Encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The internal API is designed to expect requests and responses in
the <a href="http://www.ietf.org/rfc/rfc3629.txt">UTF-8</a> encoding.  However, to allow simple implementations
that operate on a per-byte level, all characters with special meaning
are taken from the single-byte UTF-8 subset (that is, ASCII).  In
addition, the backslash-escape mechanism (see below) operates only on
one byte.</p>
</div>
<div class="paragraph">
<p>API users <strong>must</strong> support the sending and receiving of all single-byte
UTF-8 character codes (that is, ASCII), and <strong>should</strong> support the
sending and receiving of the full UTF-8 range subject to the
limitations below.</p>
</div>
<div class="paragraph">
<p>While a message is in transit, API users <strong>must not</strong> alter its bytes in
any way other than changing between equivalent quoting, escaping and
line/word-delimiting forms.  This includes correcting, omitting, or
replacing any non-UTF-8 byte sequences, as well as case folding or
normalising.  However, changing from double quotes to single quotes
as well as introducing or removing more whitespace to an inter-word
whitespace run is acceptable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message protocol uses the linefeed-delimited <em>commands</em>, each
containing one or more whitespace-delimited
<em>words</em>.  Each word consists of a sequence of bytes (usually
representing UTF-8 characters).</p>
</div>
<div class="sect2">
<h3 id="_quoting_and_escaping"><a class="anchor" href="#_quoting_and_escaping"></a>Quoting and escaping</h3>
<div class="paragraph">
<p>To allow all byte sequences to be represented in words, the protocol
uses several quoting and escaping strategies, which are summarised in
the below table and formalised later.</p>
</div>
<div class="paragraph">
<p>Note that, while each quoting mechanism lasts until the matching (and
non-backslash-escaped) quote is found, backslash-escape affects only
the following byte (then, the previous quoting behaviour returns
afterwards).</p>
</div>
<div class="paragraph">
<p>Also note that backslash-escape only escapes the next <em>byte</em>: for this
reason, clients and services <strong>should not</strong> backslash-escape multi-byte
UTF-8 characters (such treatment is unnecessary, as all special
characters are single-byte).</p>
</div>
<div class="paragraph">
<p>Finally, backslashes <strong>must not</strong> be interpreted as starting an escape
while in backslash-escape or double-quoted modes, and <strong>must</strong> be
emitted verbatim.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Quoting and escaping strategies</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Character</th>
<th class="tableblock halign-left valign-top">Meaning when unquoted</th>
<th class="tableblock halign-left valign-top">Meaning when single-quoted</th>
<th class="tableblock halign-left valign-top">Meaning when double-quoted</th>
<th class="tableblock halign-left valign-top">Meaning when backslash-escaped</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'</code> (0x27)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Begins single-quoted mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Begins unquoted mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"</code> (0x22)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Begins double-quoted mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ends double-quoted mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\</code> (0x5C)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Begins backslash escape for next byte only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Begins backslash escape for next byte only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any other byte 'b'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'b'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'b'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'b'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'b'</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_formal_specification"><a class="anchor" href="#_formal_specification"></a>Formal Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message protocol adheres to the following BNF grammar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;command&gt;     ::= &lt;words&gt; "\n"
               |  &lt;whitespace&gt; &lt;words&gt; "\n"
               |  &lt;words&gt; &lt;whitespace&gt; "\n"
               |  &lt;whitespace&gt; &lt;words&gt; &lt;whitespace&gt; "\n"

&lt;words&gt;       ::= &lt;word&gt;
               |  &lt;word&gt; &lt;whitespace&gt; &lt;words&gt;

&lt;word&gt;        ::= "'" &lt;single&gt;
               |  "'" &lt;single&gt; &lt;word&gt;
               |  "\"" &lt;double&gt;
               |  "\"" &lt;double&gt; &lt;word&gt;
               | &lt;escape&gt;
               | &lt;escape&gt; &lt;word&gt;
               | &lt;normal-char&gt;
               | &lt;normal-char&gt; &lt;word&gt;

&lt;single&gt;      ::= "'"
               |  &lt;single-char&gt; &lt;single&gt;

&lt;double&gt;      ::= "\""
               |  &lt;escape&gt; &lt;double&gt;
               |  &lt;double-char&gt; &lt;double&gt;

&lt;whitespace&gt;  ::= &lt;ws-char&gt;
               |  &lt;ws-char&gt; &lt;whitespace&gt;

&lt;escape&gt;      ::= "\\" &lt;any-char&gt;

&lt;ws-char&gt;     ::= " " | "\t" | "\v" | "\f" | "\r"
&lt;normal-char&gt; ::= (any byte not in &lt;ws-char&gt; or one of " ' \ \n)
&lt;double-char&gt; ::= (any byte except one of " \)
&lt;single-char&gt; ::= (any byte except ')
&lt;any-char&gt;    ::= (any byte)</pre>
</div>
</div>
<div class="paragraph">
<p>Each distinct <code>word</code> and <code>command</code> production denotes a separate word
and command respectively.  Any <code>normal-char</code>, <code>double-char</code>,
<code>single-char</code>, or <code>any-char</code> is emitted verbatim in its word.</p>
</div>
<div class="paragraph">
<p>Syntax errors (for example, a line containing no words) <strong>must</strong> cause a
<code>WHAT</code> response to be sent.</p>
</div>
<div class="paragraph">
<p>Escape sequences in the above BNF may be interpreted as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. BNF escape sequences</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sequence</th>
<th class="tableblock halign-left valign-top">Byte</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x09</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Horizontal tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\n</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0A</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\v</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0B</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vertical tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0C</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Form feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\r</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0B</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carriage return</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\\</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x5C</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backslash</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
